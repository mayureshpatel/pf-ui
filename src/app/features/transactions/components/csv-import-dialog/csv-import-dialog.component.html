<p-dialog
  header="Import Transactions from CSV"
  [modal]="true"
  [visible]="visible()"
  (visibleChange)="onHide()"
  [style]="{ width: '800px' }"
  [draggable]="false"
  [resizable]="false">

  <div class="flex flex-col gap-4">
    @if (errorMessage()) {
      <p-message severity="error" [text]="errorMessage()!" styleClass="w-full" />
    }

    <!-- Step 1: Upload Configuration -->
    @if (currentStep() === 0) {
      <div class="flex flex-col gap-4">
        <p class="text-muted-color">
          Select an account, choose your bank's CSV format, and upload your transaction file.
        </p>

        <!-- Account Selection -->
        <div class="flex flex-col gap-2">
          <label for="account" class="font-medium text-color">
            Account <span class="text-red-500">*</span>
          </label>
          <p-select
            id="account"
            [(ngModel)]="selectedAccountId"
            [options]="accountOptions()"
            optionLabel="label"
            optionValue="value"
            placeholder="Select account"
            styleClass="w-full"
            appendTo="body"
          />
          <small class="text-muted-color">
            Choose the account where these transactions belong
          </small>
        </div>

        <!-- Bank Format Selection -->
        <div class="flex flex-col gap-2">
          <label for="bank" class="font-medium text-color">
            Bank Format <span class="text-red-500">*</span>
          </label>
          <p-select
            id="bank"
            [(ngModel)]="selectedBankName"
            [options]="bankOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="Select bank format"
            styleClass="w-full"
            appendTo="body">
            <ng-template let-option pTemplate="item">
              <div class="flex flex-col">
                <span class="font-medium">{{ option.label }}</span>
                <small class="text-muted-color">{{ option.description }}</small>
              </div>
            </ng-template>
          </p-select>
          <small class="text-muted-color">
            Choose the format that matches your CSV file
          </small>
        </div>

        <!-- File Upload -->
        <div class="flex flex-col gap-2">
          <label class="font-medium text-color">
            CSV File <span class="text-red-500">*</span>
          </label>
          <p-fileupload
            mode="basic"
            accept=".csv"
            [maxFileSize]="5000000"
            [auto]="false"
            (onSelect)="onFileSelect($event)"
            (onClear)="onFileClear()"
            chooseLabel="Choose CSV File"
            styleClass="w-full"
          />
          @if (selectedFile()) {
            <small class="text-color">
              Selected: {{ selectedFile()!.name }} ({{ (selectedFile()!.size / 1024).toFixed(2) }} KB)
            </small>
          }
          <small class="text-muted-color">
            Maximum file size: 5MB
          </small>
        </div>
      </div>
    }

    <!-- Step 2: Preview Transactions -->
    @if (currentStep() === 1) {
      <div class="flex flex-col gap-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-lg font-semibold text-color">
              {{ previews().length }} transaction(s) found
            </p>
            <p class="text-sm text-muted-color">
              Review the imported transactions before saving
            </p>
          </div>
        </div>

        <!-- Preview Table -->
        <p-table
          [value]="previews()"
          [scrollable]="true"
          scrollHeight="400px"
          styleClass="p-datatable-sm">

          <ng-template pTemplate="header">
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Vendor</th>
              <th>Category</th>
              <th>Type</th>
              <th class="text-right">Amount</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-preview>
            <tr>
              <!-- Date -->
              <td>
                <span class="font-medium">{{ formatDate(preview.date) }}</span>
              </td>

              <!-- Description -->
              <td>
                <span class="text-color">{{ preview.description || '-' }}</span>
              </td>

              <!-- Vendor -->
              <td>
                <span class="text-color">{{ preview.vendorName || '-' }}</span>
              </td>

              <!-- Category -->
              <td>
                <p-tag
                  [value]="getCategoryDisplay(preview.suggestedCategory)"
                  [severity]="getCategorySeverity(preview.suggestedCategory)"
                  styleClass="text-xs"
                />
              </td>

              <!-- Type -->
              <td>
                <div class="flex items-center gap-2">
                  <i [class]="'pi ' + getTransactionTypeInfo(preview.type).icon + ' ' + getTransactionTypeInfo(preview.type).color"></i>
                  <span>{{ getTransactionTypeInfo(preview.type).label }}</span>
                </div>
              </td>

              <!-- Amount -->
              <td class="text-right">
                <span class="font-semibold" [ngClass]="getAmountClass(preview.type)">
                  {{ formatTransactionAmount(preview.amount, preview.type) }}
                </span>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="text-center py-8 text-muted-color">
                No transactions to preview
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <div class="flex items-center justify-between w-full">
      <!-- Left side: Back button (only on step 2) -->
      <div>
        @if (currentStep() === 1) {
          <p-button
            label="Back"
            icon="pi pi-arrow-left"
            (onClick)="goBack()"
            [text]="true"
            severity="secondary"
            [disabled]="saving()"
          />
        }
      </div>

      <!-- Right side: Cancel and Action buttons -->
      <div class="flex gap-2">
        <p-button
          label="Cancel"
          icon="pi pi-times"
          (onClick)="onHide()"
          [text]="true"
          severity="secondary"
          [disabled]="uploading() || saving()"
        />

        @if (currentStep() === 0) {
          <p-button
            label="Preview"
            icon="pi pi-eye"
            (onClick)="uploadAndPreview()"
            [loading]="uploading()"
            [disabled]="!canProceedToPreview()"
            severity="primary"
          />
        }

        @if (currentStep() === 1) {
          <p-button
            label="Import Transactions"
            icon="pi pi-check"
            (onClick)="saveTransactions()"
            [loading]="saving()"
            [disabled]="!canSave()"
            severity="primary"
          />
        }
      </div>
    </div>
  </ng-template>
</p-dialog>
