<div class="p-4">
  <!-- Page Header -->
  <app-screen-toolbar>
    <div toolbarTitle>
      <h1 class="text-3xl font-bold text-color">Vendor Rules</h1>
      <p class="text-muted-color mt-1">Automatically rename messy bank descriptions</p>
    </div>

    <div toolbarActions>
      <p-button
        label="Apply Rules"
        icon="pi pi-refresh"
        (onClick)="openApplyPreview()"
        severity="secondary"
        [outlined]="true"
      />
      <p-button
        label="New Rule"
        icon="pi pi-plus"
        (onClick)="openCreateDialog()"
        severity="primary"
      />
    </div>
  </app-screen-toolbar>

  <!-- Rules Table -->
  <p-card styleClass="shadow-sm">
    <p-table
      [value]="rules()"
      [loading]="loading()"
      styleClass="p-datatable-sm"
      responsiveLayout="scroll">

      <ng-template pTemplate="header">
        <tr>
          <th>Priority</th>
          <th>If Description Contains...</th>
          <th>Rename To...</th>
          <th class="text-center" style="width: 100px">Action</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-rule>
        <tr>
          <td>
            <span class="text-muted-color">{{ rule.priority }}</span>
          </td>
          <td class="font-mono text-sm px-2 py-1 rounded">
            {{ rule.keyword }}
          </td>
          <td class="font-medium text-primary">
            {{ rule.vendorName }}
          </td>
          <td class="text-center">
            <p-button
              icon="pi pi-trash"
              [text]="true"
              [rounded]="true"
              severity="danger"
              (onClick)="deleteRule(rule)"
              pTooltip="Delete Rule"
              tooltipPosition="top"
            />
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="4" class="text-center py-8 text-muted-color">
            No rules found. Create one to start cleaning up your transactions.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Unmatched Vendors -->
  @if (unmatchedVendors().length > 0) {
    <p-card styleClass="shadow-sm mt-6">
      <ng-template pTemplate="title">
        <div class="flex items-center gap-2">
          <i class="pi pi-exclamation-circle text-warning"></i>
          Vendors without rules
        </div>
      </ng-template>

      <p-table
        [value]="unmatchedVendors()"
        styleClass="p-datatable-sm"
        responsiveLayout="scroll">

        <ng-template pTemplate="header">
          <tr>
            <th>Raw Description</th>
            <th class="text-center" style="width: 120px">Occurrences</th>
            <th class="text-center" style="width: 140px">Action</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-vendor>
          <tr>
            <td class="font-mono text-sm">{{ vendor.originalName }}</td>
            <td class="text-center">
              <span class="text-muted-color">{{ vendor.count }}</span>
            </td>
            <td class="text-center">
              <p-button
                label="Create Rule"
                icon="pi pi-plus"
                [text]="true"
                severity="primary"
                (onClick)="createRuleFromUnmatched(vendor)"
              />
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  }

  <!-- Create Rule Drawer -->
  <app-vendor-rule-form-drawer
    [(visible)]="showDialog"
    [initialKeyword]="initialKeyword()"
    (save)="onRuleSaved()"
  />

  <!-- Apply Rules Preview Dialog -->
  <app-apply-rules-dialog
    [visible]="showApplyDialog()"
    [previewItems]="previewItems()"
    fieldLabel="Vendor Name"
    (visibleChange)="showApplyDialog.set($event)"
    (confirm)="confirmApply()"
  />
</div>
