<app-drawer
  [(visible)]="visible"
  [title]="drawerTitle"
  [icon]="drawerIcon"
  [saving]="saving()"
  [saveLabel]="isEditMode ? 'Update' : 'Create'"
  (save)="onSubmit()"
  (cancel)="onHide()">

  <form class="flex flex-col gap-6">
    @if (errorMessage()) {
      <p-message severity="error" [text]="errorMessage()!" styleClass="w-full" />
    }

    <!-- Account Name -->
    <div class="flex flex-col gap-2">
      <label for="name" class="text-sm font-medium text-surface-700">
        Account Name <span class="text-red-500">*</span>
      </label>
      <input
        pInputText
        id="name"
        [(ngModel)]="formData.name"
        name="name"
        placeholder="e.g., Main Checking, Travel Savings"
        class="w-full"
        maxlength="100"
        required
      />
    </div>

    <!-- Account Type -->
    <div class="flex flex-col gap-2">
      <label for="type" class="text-sm font-medium text-surface-700">
        Account Type <span class="text-red-500">*</span>
      </label>
      <p-select
        id="type"
        [(ngModel)]="formData.type"
        name="type"
        [options]="accountTypes"
        optionLabel="label"
        optionValue="value"
        placeholder="Select account type"
        styleClass="w-full"
        required>
        <ng-template let-option pTemplate="item">
          <div class="flex items-center gap-2">
            <i [class]="'pi ' + option.icon + ' text-surface-400'"></i>
            <span>{{ option.label }}</span>
          </div>
        </ng-template>
      </p-select>
    </div>

    <!-- Bank Format (Optional) -->
    <div class="flex flex-col gap-2">
      <label for="bankName" class="text-sm font-medium text-surface-700">
        Default Bank Format
      </label>
      <p-select
        id="bankName"
        [(ngModel)]="formData.bankName"
        name="bankName"
        [options]="bankOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Select bank format"
        styleClass="w-full"
        appendTo="body"
        [showClear]="true">
        <ng-template let-option pTemplate="item">
          <div class="flex flex-col">
            <span class="font-medium">{{ option.label }}</span>
            <small class="text-muted-color">{{ option.description }}</small>
          </div>
        </ng-template>
      </p-select>
      <small class="text-muted-color">
        Automatically selects the correct CSV parser for imports
      </small>
    </div>

    <!-- Current Balance (Only for creation or context) -->
    <div class="flex flex-col gap-2">
      <label for="balance" class="text-sm font-medium text-surface-700">
        Current Balance <span class="text-red-500">*</span>
      </label>
      
      @if (!isEditMode) {
        <p-inputNumber
          id="balance"
          [(ngModel)]="formData.currentBalance"
          name="balance"
          mode="currency"
          currency="USD"
          locale="en-US"
          [minFractionDigits]="2"
          [maxFractionDigits]="2"
          styleClass="w-full"
          inputStyleClass="w-full font-bold text-lg"
          required
        />
        <small class="text-muted-color">
          Initial balance for the new account.
        </small>
      } @else {
        <div class="flex items-center gap-3">
          <span class="text-2xl font-bold font-mono">
            {{ formData.currentBalance | currency }}
          </span>
          <p-button 
            label="Reconcile" 
            icon="pi pi-check-circle" 
            severity="secondary" 
            size="small"
            (onClick)="openReconcileDialog()"
          />
        </div>
        <small class="text-muted-color italic">
          Balance cannot be edited directly. Use 'Reconcile' to adjust.
        </small>
      }
    </div>
  </form>
  
  @if (isEditMode && account()) {
    <app-reconcile-dialog
      [(visible)]="showReconcileDialog"
      [account]="account()!"
      (reconciled)="onReconciled()"
    />
  }
</app-drawer>