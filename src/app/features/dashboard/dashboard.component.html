<div class="p-4">
  <!-- Page Header -->
  <app-screen-toolbar [showDivider]="false">
    <div toolbarTitle>
      <h1 class="text-3xl font-bold text-color">Dashboard</h1>
      <p class="text-muted-color mt-1">Operational Command Center</p>
    </div>

    <div toolbarFilters>
      <!-- Period Filters -->
      <div class="flex flex-wrap gap-4 items-center p-2 rounded-xl bg-surface-50 dark:bg-surface-900 border border-surface-200 dark:border-surface-800">
        <p-selectButton
          [(ngModel)]="selectedPreset"
          [options]="presetOptions"
          optionLabel="label"
          optionValue="value"
          (onChange)="onPeriodChange()"
          styleClass="custom-selectbutton"
        />

        @if (selectedPreset() === 'CUSTOM') {
          <div class="flex gap-2 animate-in fade-in slide-in-from-left-2 duration-300">
            <p-select
              [(ngModel)]="selectedMonth"
              [options]="monthOptions"
              optionLabel="label"
              optionValue="value"
              (onChange)="onPeriodChange()"
              styleClass="w-36 border-none bg-transparent"
            />
            <p-select
              [(ngModel)]="selectedYear"
              [options]="yearOptions"
              optionLabel="label"
              optionValue="value"
              (onChange)="onPeriodChange()"
              styleClass="w-24 border-none bg-transparent"
            />
          </div>
        }
      </div>
    </div>
  </app-screen-toolbar>

  @if (loading()) {
    <div class="flex justify-center items-center py-12">
      <p-progressSpinner styleClass="w-16 h-16" />
    </div>
  } @else {
    <!-- Row 1: The Pulse -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <app-pulse-card
        title="Total Income"
        [value]="pulse()?.currentIncome || 0"
        [previousValue]="pulse()?.previousIncome || 0"
        color="text-green-600"
      />
      <app-pulse-card
        title="Total Expenses"
        [value]="pulse()?.currentExpense || 0"
        [previousValue]="pulse()?.previousExpense || 0"
        [inverseTrend]="true"
        color="text-red-600"
      />
      <app-pulse-card
        title="Savings Rate"
        [value]="pulse()?.currentSavingsRate || 0"
        [previousValue]="pulse()?.previousSavingsRate || 0"
        type="percent"
        [color]="getSavingsRateColor(pulse()?.currentSavingsRate)"
      />
    </div>

    <!-- Row 2: The Big Picture -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div class="lg:col-span-2">
        <app-cash-flow-trend [data]="trends()" />
      </div>
      <div class="lg:col-span-1">
        <app-ytd-summary
          [year]="ytd()?.year || selectedYear()"
          [totalIncome]="ytd()?.totalIncome || 0"
          [totalExpense]="ytd()?.totalExpense || 0"
          [avgSavingsRate]="ytd()?.avgSavingsRate || 0"
        />
      </div>
    </div>

    <!-- Row 3: Analysis & Action -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Top Categories -->
      <div class="lg:col-span-1">
        <app-category-chart
          title="Spending by Category"
          [categories]="topCategories()"
        />
      </div>

      <!-- Top Merchants -->
      <div class="lg:col-span-1">
        <p-card styleClass="h-full shadow-sm">
          <ng-template pTemplate="title">
            <div class="flex items-center gap-2">
              <i class="pi pi-shop text-primary"></i>
              <span class="text-xl font-bold text-surface-900">Top Merchants</span>
            </div>
          </ng-template>
          
          <div class="flex flex-col gap-4">
            @for (merchant of topVendors(); track merchant.vendorName) {
              <div class="flex justify-between items-center p-3 rounded-lg bg-surface-50 dark:bg-surface-900 border border-surface-100 dark:border-surface-800 transition-hover hover:shadow-xs">
                <div class="flex flex-col">
                  <span class="font-semibold text-surface-900">{{ merchant.vendorName }}</span>
                  <span class="text-xs text-muted-color">High Frequency</span>
                </div>
                <div class="flex flex-col items-end">
                  <span class="font-bold text-primary">{{ merchant.total | currency:'USD' }}</span>
                  <span class="text-[10px] text-muted-color uppercase font-medium">This Period</span>
                </div>
              </div>
            } @empty {
              <div class="flex flex-col items-center justify-center py-12 text-muted-color italic text-sm">
                No merchant data for this period
              </div>
            }
          </div>
        </p-card>
      </div>

      <!-- Action Center -->
      <div class="lg:col-span-1">
        <app-action-center [items]="actions()" />
      </div>
    </div>
  }
</div>
