<div class="p-4">
  <!-- Page Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-bold text-color">Budgets</h1>
      <p class="text-muted-color mt-1">Set monthly spending limits and track progress</p>
    </div>

    <div class="flex gap-3">
      <!-- Period Filters -->
      <div class="flex flex-wrap gap-3 items-end p-3 rounded-lg border border-surface-200 dark:border-surface-700">
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold text-muted-color uppercase">Month</label>
          <p-select
            [(ngModel)]="selectedMonth"
            [options]="monthOptions"
            optionLabel="label"
            optionValue="value"
            (onChange)="onPeriodChange()"
            styleClass="w-40 border-none bg-transparent"
          />
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold text-muted-color uppercase">Year</label>
          <p-select
            [(ngModel)]="selectedYear"
            [options]="yearOptions"
            optionLabel="label"
            optionValue="value"
            (onChange)="onPeriodChange()"
            styleClass="w-28 border-none bg-transparent"
          />
        </div>
      </div>

      <p-button
        label="Set Budget"
        icon="pi pi-plus"
        (onClick)="openSetBudgetDialog()"
        severity="primary"
      />
    </div>
  </div>

  @if (loading()) {
    <div class="flex justify-center items-center py-12">
      <p-progressSpinner styleClass="w-16 h-16" />
    </div>
  } @else {
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <p-card styleClass="shadow-sm border-l-4 border-primary">
        <div class="flex flex-col gap-1">
          <span class="text-xs font-semibold text-muted-color uppercase">Total Budgeted</span>
          <span class="text-2xl font-bold text-color">{{ formatCurrency(totalBudgeted()) }}</span>
        </div>
      </p-card>
      <p-card styleClass="shadow-sm border-l-4 border-red-500">
        <div class="flex flex-col gap-1">
          <span class="text-xs font-semibold text-muted-color uppercase">Total Spent</span>
          <span class="text-2xl font-bold text-color">{{ formatCurrency(totalSpent()) }}</span>
        </div>
      </p-card>
      <p-card [styleClass]="'shadow-sm border-l-4 ' + (totalRemaining() >= 0 ? 'border-green-500' : 'border-red-500')">
        <div class="flex flex-col gap-1">
          <span class="text-xs font-semibold text-muted-color uppercase">Remaining</span>
          <span [class]="'text-2xl font-bold ' + (totalRemaining() >= 0 ? 'text-green-500' : 'text-red-500')">
            {{ formatCurrency(totalRemaining()) }}
          </span>
        </div>
      </p-card>
    </div>

        <!-- Budget Status List -->
        <p-card styleClass="shadow-sm">
          <p-table
            [value]="budgetStatuses()"
            styleClass="p-datatable-sm"
            responsiveLayout="scroll">
            
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 50px"></th>
                <th>Category</th>
                <th class="text-right">Budgeted</th>
                <th class="text-right">Spent</th>
                <th style="width: 30%">Progress</th>
                <th class="text-right">Remaining</th>
              </tr>
            </ng-template>
    
            <ng-template pTemplate="body" let-status>
              <tr>
                <td>
                  <div [class]="(status.color || getCategoryColor(status.categoryName)) + ' w-8 h-8 rounded-full flex items-center justify-center text-white'">
                    @if (status.icon) {
                      <i [class]="'pi ' + status.icon + ' text-xs'"></i>
                    }
                  </div>
                </td>
                <td class="font-medium">{{ status.categoryName }}</td>            <td class="text-right">{{ formatCurrency(status.budgetedAmount) }}</td>
            <td class="text-right text-red-500">{{ formatCurrency(status.spentAmount) }}</td>
            <td>
              <div class="flex flex-col gap-1">
                <p-progressBar
                  [value]="status.percentageUsed"
                  [showValue]="false"
                  [styleClass]="'h-2 ' + getProgressBarTailwind(status.percentageUsed)">
                </p-progressBar>
                <span class="text-xs text-muted-color text-right">
                  {{ status.percentageUsed.toFixed(0) }}% used
                </span>
              </div>
            </td>
            <td [class]="'text-right font-semibold ' + (status.remainingAmount >= 0 ? 'text-green-500' : 'text-red-500')">
              {{ formatCurrency(status.remainingAmount) }}
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center py-8 text-muted-color">
              No budgets set for this period. Click "Set Budget" to get started.
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  }

  <!-- Set Budget Dialog -->
  <app-budget-form-dialog
    [visible]="showDialog()"
    (visibleChange)="showDialog.set($event)"
    [categories]="categories()"
    [month]="selectedMonth()"
    [year]="selectedYear()"
    (save)="onBudgetSaved()"
  />
</div>
