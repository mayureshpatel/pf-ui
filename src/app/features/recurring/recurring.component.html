<div class="p-4">
  <!-- Page Header -->
  <app-screen-toolbar>
    <div toolbarTitle>
      <h1 class="text-3xl font-bold text-color">Recurring Transactions</h1>
      <p class="text-muted-color mt-1">Track your subscriptions and bills</p>
    </div>

    <div toolbarActions>
      <p-button
        label="Scan History"
        icon="pi pi-search"
        (onClick)="openScanDialog()"
        severity="info"
        [outlined]="true"
      />
      <p-button
        label="New Recurring"
        icon="pi pi-plus"
        (onClick)="openCreateDialog()"
        severity="primary"
      />
    </div>
  </app-screen-toolbar>

  <!-- List -->
  <p-card styleClass="shadow-sm">
    <p-table
      [value]="recurringTransactions()"
      [loading]="loading()"
      styleClass="p-datatable-sm"
      responsiveLayout="scroll">
      
      <ng-template pTemplate="header">
        <tr>
          <th>Merchant</th>
          <th>Account</th>
          <th>Frequency</th>
          <th class="text-right">Amount</th>
          <th>Next Due</th>
          <th class="text-center">Status</th>
          <th class="text-center" style="width: 100px">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-txn>
        <tr [class.opacity-50]="!txn.active">
          <td class="font-medium">{{ txn.merchantName }}</td>
          <td class="text-muted-color">{{ txn.accountName || '-' }}</td>
          <td>
            <p-tag [value]="txn.frequency" severity="secondary" styleClass="text-xs"></p-tag>
          </td>
          <td class="text-right font-semibold">{{ formatCurrency(txn.amount) }}</td>
          <td>{{ formatDate(txn.nextDate) }}</td>
          <td class="text-center">
            @if (txn.active) {
              <p-tag 
                [value]="getDueStatusLabel(getDaysUntilDue(txn.nextDate))" 
                [severity]="getDueStatusSeverity(getDaysUntilDue(txn.nextDate))"
                styleClass="text-xs">
              </p-tag>
            } @else {
              <p-tag value="Inactive" severity="contrast" styleClass="text-xs"></p-tag>
            }
          </td>
          <td class="text-center">
            <div class="flex justify-center gap-2">
              <p-button
                icon="pi pi-pencil"
                [text]="true"
                [rounded]="true"
                severity="info"
                (onClick)="openEditDialog(txn)"
                pTooltip="Edit"
                tooltipPosition="top"
              />
              <p-button
                icon="pi pi-trash"
                [text]="true"
                [rounded]="true"
                severity="danger"
                (onClick)="deleteRecurring(txn)"
                pTooltip="Delete"
                tooltipPosition="top"
              />
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center py-8 text-muted-color">
            No recurring transactions found.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Form Dialog -->
  <app-recurring-form-dialog
    [visible]="showDialog()"
    (visibleChange)="showDialog.set($event)"
    [transaction]="selectedTransaction()"
    [accounts]="accounts()"
    (save)="onSave()"
  />

  <!-- Scan Dialog -->
  <app-recurring-scan-dialog
    [visible]="showScanDialog()"
    (visibleChange)="showScanDialog.set($event)"
    (save)="onSave()"
  />

  <!-- Confirmation Dialog -->
  <p-confirmDialog />
</div>
