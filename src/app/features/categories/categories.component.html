<div class="p-4">
  <!-- Page Header -->
  <app-screen-toolbar>
    <div toolbarTitle>
      <h1 class="text-3xl font-bold text-color">Categories</h1>
      <p class="text-muted-color mt-1">Manage your transaction categories</p>
    </div>

    <div toolbarActions>
      <p-button
        label="New Category"
        icon="pi pi-plus"
        (onClick)="openCreateDialog()"
        severity="primary"
      />
    </div>
  </app-screen-toolbar>

  <!-- Categories Table with Row Grouping -->
  @if (!isEmpty()) {
    <p-card styleClass="shadow-sm">
      <p-table
        [value]="categories()"
        [loading]="loading()"
        [paginator]="false"
        styleClass="p-datatable-sm"
        rowGroupMode="subheader"
        groupRowsBy="groupName"
        sortField="groupName"
        sortMode="single"
        [scrollable]="true"
        scrollHeight="600px">

        <ng-template pTemplate="header">
          <tr>
            <th style="width: 60px"></th>
            <th>Category Name</th>
            <th class="text-center" style="width: 150px">Usage</th>
            <th class="text-right" style="width: 120px">Budget</th>
            <th style="width: 200px">Monthly Progress</th>
            <th class="text-center" style="width: 120px">Actions</th>
          </tr>
        </ng-template>

        <!-- Group Header -->
        <ng-template pTemplate="groupheader" let-category>
          <tr pRowGroupHeader>
            <td colspan="6">
              <div class="flex items-center gap-2 py-1">
                <span class="font-bold text-lg text-primary uppercase tracking-wide">{{ category.groupName }}</span>
                <span class="text-sm text-muted-color font-normal">
                  ({{ calculateGroupTotal(category.groupName) }} transactions)
                </span>
              </div>
            </td>
          </tr>
        </ng-template>

        <!-- Data Rows -->
        <ng-template pTemplate="body" let-category let-rowIndex="rowIndex">
          <tr>
            <!-- Color Badge / Icon -->
            <td>
              <div
                [class]="getDisplayColor(category) + ' w-8 h-8 rounded-full ml-4 flex items-center justify-center text-white cursor-help'"
                [pTooltip]="getIconLabel(category.icon)"
                tooltipPosition="top">
                @if (category.icon) {
                  <i [class]="'pi ' + category.icon + ' text-sm'"></i>
                }
              </div>
            </td>

            <!-- Category Name -->
            <td>
              <div class="flex flex-col">
                <span class="font-medium">{{ category.name }}</span>
                @if (category.type) {
                  <span class="text-xs text-muted-color capitalize">{{ category.type.toLowerCase() }}</span>
                }
              </div>
            </td>

            <!-- Usage Count -->
            <td class="text-center">
              <span
                class="text-primary hover:underline cursor-pointer"
                (click)="viewTransactions(category)"
                pTooltip="View transactions"
                tooltipPosition="top">
                {{ category.transactionCount }} transaction{{ category.transactionCount !== 1 ? 's' : '' }}
              </span>
            </td>

            <!-- Budget -->
            <td class="text-right font-medium">
              {{ category.budgetedAmount ? formatCurrency(category.budgetedAmount) : '-' }}
            </td>

            <!-- Monthly Progress -->
            <td>
              @if (category.budgetedAmount !== undefined) {
                <div class="flex flex-col gap-1 pr-4">
                  <p-progressBar
                    [value]="category.percentageUsed"
                    [showValue]="false"
                    [styleClass]="'h-2 ' + getProgressBarTailwind(category.percentageUsed)">
                  </p-progressBar>
                  <span class="text-xs text-muted-color text-right">
                    {{ category.percentageUsed?.toFixed(0) }}% used
                  </span>
                </div>
              } @else {
                <span class="text-xs text-muted-color italic">No budget set</span>
              }
            </td>

            <!-- Actions -->
            <td class="text-center">
              <div class="flex justify-center gap-1">
                <p-button
                  icon="pi pi-pencil"
                  [text]="true"
                  [rounded]="true"
                  severity="info"
                  (onClick)="openEditDialog(category)"
                  pTooltip="Edit"
                  tooltipPosition="top"
                />
                <p-button
                  icon="pi pi-trash"
                  [text]="true"
                  [rounded]="true"
                  severity="danger"
                  (onClick)="deleteCategory(category)"
                  [disabled]="category.transactionCount > 0"
                  [pTooltip]="category.transactionCount > 0 ? 'Cannot delete category with transactions' : 'Delete'"
                  tooltipPosition="top"
                />
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center py-8 text-muted-color">
              No categories found
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  }

  <!-- Empty State -->
  @if (isEmpty()) {
    <p-card styleClass="shadow-sm">
      <div class="flex flex-col items-center justify-center py-12">
        <i class="pi pi-tags text-6xl text-muted-color mb-4"></i>
        <h2 class="text-2xl font-semibold text-color mb-2">No categories yet</h2>
        <p class="text-muted-color mb-6 text-center max-w-md">
          Get started by creating your first category to organize your transactions
        </p>
        <p-button
          label="Add Your First Category"
          icon="pi pi-plus"
          (onClick)="openCreateDialog()"
          severity="primary"
          size="large"
        />
      </div>
    </p-card>
  }

  <!-- Form Dialog -->
  <app-category-form-dialog
    [visible]="showDialog()"
    [category]="selectedCategory()"
    (visibleChange)="showDialog.set($event)"
    (save)="onSave($event)"
  />

  <p-confirmDialog/>
</div>
